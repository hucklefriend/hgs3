さくらのVPSを契約

石狩第一
一番安いやつ
50GB

Ubuntu 18.04
スタートアッププロジェクトなし


クレカ支払


数分待つとサーバー一覧に追加
SSHでつなぐぞー→つながらない
電源入れてないやん

電源ON
コンソール（ブラウザ）


sudo apt update
sudo apt upgrade

sudo do-release-upgrade
めっちゃ時間かかるけどいい？みたいなことを聞かれるのでOK
しばらく画面を見ていると、Yes Noを選ぶ部分があるが、テキトーにYes
アップデートの際にサービスの再起動が必要かどうか聞かなくてもいい？
みたいな質問なので、Yesを選択
現時点で何も動いてないですしね。

ntp.confが上書きされるという話
Dで内容確認すると、poolなんちゃらみたいな設定が追加されている模様
ntpなら大した問題ではないと判断し、Nで先へ進める
必要ならあとで書き加えればよし


crontabの変更ありとのこと
Dで確認すると、微妙に実行時間に差異があるものの、
内容はテスト用の初期設定があるままなので、ここもNで現状維持を選択

sshd_configで変更ありとのこと
show the difference between the versions
で内容を確認
現状維持がよさそうなので、
keep the local version currently installedを選択


40個のパッケージが削除されるけどいい？と聞かれる
dで内容確認しようとしたら間違えて何も押さずにENTERを押してしまい確認できず

最後リスタートするかい？と聞かれるので、yでリスタート

すると



各種コンポーネントをインストールしていきます。

○apache

sudo apt install apache2
sudo a2enmod rewrite
sudo systemctl enable apache2

○PHP 7.4

sudo apt install software-properties-common
sudo add-apt-repository ppa:ondrej/php
sudo apt update
sudo apt upgrade
sudo apt install php7.4


○composer

sudo apt install composer


○MariaDB

https://downloads.mariadb.org/mariadb/repositories/#distro=Ubuntu&distro_release=focal--ubuntu_focal&mirror=yamagata-university&version=10.5

sudo mysql_secure_installation

sudo systemctl enable mysql

remove anonymous users y
Dissallow root login remotely? y




○redis
sudo apt install redis-server

#redisは systemctl enableできないみたい

○mongoDB
https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/
sudo wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | sudo apt-key add -
sudo echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/4.4 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.4.list
sudo sudo apt-get update
sudo apt-get install -y mongodb-org

sudo systemctl start mongod
sudo systemctl enable mongod


〇PHP用コンポーネント
sudo apt install php7.4-mongodb php7.4-redis



さくらのドメイン



ssl証明書
https://qiita.com/daiki_44/items/a3616390f277722b97e0

sudo apt -y install certbot

sudo certbot certonly --webroot -w /var/www/html -d horrorgame.net

/etc/letsencrypt/live/horrorgame.net/privkey.pem

SSLCertificateFile      /etc/letsencrypt/live/dev.horrorgame.net/cert.pem
SSLCertificateKeyFile   /etc/letsencrypt/live/dev.horrorgame.net/privkey.pem
SSLCertificateChainFile /etc/letsencrypt/live/dev.horrorgame.net/chain.pem

sudo certbot renew --post-hook "systemctl restart httpd & systemctl restart vsftpd"



〇wordpress

sudo mysql

CREATE DATABASE wordpress;
GRANT ALL ON wordpress.* TO 'wordpress'@'localhost' IDENTIFIED BY 'パスワード';


wp-config.phpの設定
define('FS_METHOD','direct');


sudo apt install curl zip unzip imagemagick
sudo apt install php7.4-curl php7.4-dom php7.4-gd php7.4-imagick php7.4-imagick php7.4-zip











〇SSHの設定

バックアップ

sudo cp sshd_config sshd_config.bak

変数

sudo vi sshd_config

-#Port 22
+Port XXXXX





〇nodejs
sudo apt install nodejs npm
sudo npm install -g n
sudo n stable
sudo apt purge nodejs npm




MariaDB10.5インストール

公式サイトを参考にインストールを行いました。

sudo apt-get install software-properties-common
sudo apt-key adv --fetch-keys 'https://mariadb.org/mariadb_release_signing_key.asc'
sudo add-apt-repository 'deb [arch=amd64,arm64,ppc64el] https://ftp.yz.yamagata-u.ac.jp/pub/dbms/mariadb/repo/10.5/ubuntu focal main'
sudo apt update
sudo apt install mariadb-server

インストールはできたので、初期設定を行いました。

sudo mysql_secure_installation

いくつか質問されますが、聞かれることは簡単なことなので割愛します。こういう時にだいたいお世話になるServer Worldさんに記載がありますのでリンク貼っておきますね(;^_^A
mysql_secure_installationはいつの頃からかUnix Socket認証ってやつになってまして、サーバーのroot権限で実行することでmysqlのrootとして実行できるようになってました。ちょっと前にこれを知らなくて悩まされた記憶があります。

そして自動起動設定を行って完了です。

sudo systemctl enable mariadb










〇wordpress





sudo apt install php7.4-mysqli

CREATE USER hgs;
GRANT ALL ON *.* TO hgs;







●npm

vagrantでメモリ1GBだと足りなくてnpm installがkillされる
node.jsはdockerじゃなくてもいいかも。

npm install --no-bin-links






●vagrantたちあがらない問題発生

vboxsf is not available とか言われた時は、ホストで次を実行

$ sudo vagrant plugin install vagrant-vbguest
$ vagrant vbguest --status

vagrant haltしてからもう一回vagrant upするといける
バージョン違いで起きるらしい。